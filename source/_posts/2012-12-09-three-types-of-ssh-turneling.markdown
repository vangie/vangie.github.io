---
layout: post
title: "三种不同类型的ssh隧道"
date: 2012-12-09 13:20
comments: true
categories: 
---
>想通过ssh隧道连接远端机器的VNC服务，对`ssh -L`命令不太熟悉，`man ssh`后发现3组与隧道（turnnel）相关的参数:`ssh -D`，`ssh -L`，`ssh -R`，一下子就搞糊涂了，所有下决心仔细研究一番。

### 何谓SSH隧道

隧道是一种把一种网络协议封装进另外一种网络协议进行传输的技术。这里我们研究ssh隧道，所以所有的网络通讯都是加密的。又被称作端口转发，因为ssh隧道通常会绑定一个本地端口，所有发向这个端口端口的数据包，都会被加密并透明地传输到远端系统。

### SSH隧道的类型

ssh隧道有3种类型：

1. 动态端口转发（Socks 代理）
2. 本地端口转发
3. 远端端口转发

<!-- more -->

###动态端口转发

动态端口允许通过配置一个本地端口，把通过隧道到数据转发到远端的所有地址。本地的应用程序需要使用Socks协议与本地端口通讯。此时SSH充当Socks代理服务器的角色。

__命令格式__

	ssh -D [bind_address:]port

__参数说明__

* bind_address 指定绑定的IP地址，默认情况会绑定在本地的回环地址（即127.0.0.1），如果空值或者为`*`会绑定本地所有的IP地址，如果希望绑定的端口仅供本机使用，可以指定为`localhost`。
* port 指定本地绑定的端口

__使用场景__

假设X网络（192.168.18.0/24）有主机A（192.168.18.100）,Y网络（192.168.2.0/24）有主机B（192.168.2.100）和主机C（192.168.2.101），已知主机A可以连接主机B，但无法连接主机C。

在主机A执行

	$ ssh -D localhost:8080 root@192.168.2.100
	
然后主机A上的应用程序就可以通过

	SOCKS5 localhost:8080
	
访问主机C上的服务。

__优点__  

* 配置一个代理服务就可以访问远端机器和与其所在子网络的所有服务

__缺点__

* 应用程序需要额外配置SOCKS代理，若应用程序不支持代理配置则无法使用

###本地端口转发

通过SSH隧道，将一个远端机器能够访问到的地址和端口，映射为一个本地的端口。

![本地端口转发](/images/post/2012-12-09/local_forwarding.jpg)

__命令格式__

	ssh -L [bind_address:]port:host:hostport
	
__参数说明__

* bind_address 指定绑定的IP地址，默认情况会绑定在本地的回环地址（即127.0.0.1），如果空值或者为`*`会绑定本地所有的IP地址，如果希望绑定的端口仅供本机使用，可以指定为`localhost`。
* port 指定本地绑定的端口
* host 指定数据包转发目标地址的IP，如果目标主机和ssh server是同一台主机时该参数指定为`localhost`
* host_port 指定数据包转发目标端口

__使用场景__

假设X网络（192.168.18.0/24）有主机A（192.168.18.100）,Y网络（192.168.2.0/24）有主机B（192.168.2.100）和主机C（192.168.2.101），已知主机A可以连接主机B，但无法连接主机C。A主机需要访问C主机的VNC服务（5900端口）

在A主机上建立本地转发端口5901

	$ ssh -L 5901:192.168.2.101:5900 root@192.168.2.100

然后本地vnc客户端通过5901端口打开c主机的vnc服务

	$ open vnc://localhost:5901

__优点__  

* 无需设置代理

__缺点__  

* 每个服务都需要配置不同的端口转发


###远端端口转发

远程端口转发用于某些单向阻隔的内网环境，比如说NAT，网络防火墙。在NAT设备之后的内网主机可以直接访问公网主机，但外网主机却无法访问内网主机的服务。如果内网主机向外网主机建立一个远程转发端口，就可以让外网主机通过该端口访问该内网主机的服务。可以把这个内网主机理解为“内应”和“开门者”。

![远端端口转发](/images/post/2012-12-09/remote_forwarding.jpg)

__命令格式__

	ssh -R [bind_address:]port:host:hostport

__参数说明__

* bind_address 指定绑定的IP地址，默认情况会绑定在本地的回环地址（即127.0.0.1），如果空值或者为`*`会绑定本地所有的IP地址，如果希望绑定的端口仅供本机使用，可以指定为`localhost`。
* port 指定本地绑定的端口
* host 指定数据包转发源地址的IP，如果源主机和ssh server是同一台主机时该参数指定为`localhost`
* host_port 指定数据包转发源端口

__使用场景__

假设X网络（192.168.18.0/24）有主机A（192.168.18.100）,Y网络（192.168.2.0/24）有主机B（192.168.2.100）和主机C（192.168.2.101），已知主机A可以通过SSH访问登录B主机，但反向直接连接被禁止，主机B和主机C可以相互访问。若主机C想访问主机A的VNC服务（5900端口）。

在主机A执行如下命令，开放B主机远端端口转发。

	$ ssh -R 5900:192.168.2.100:5901 root@192.168.2.100
	
然后主机C连接主机B的5901端口

	$ open vnc://192.168.2.100:5901

__优点__

* 可以穿越防火墙和NAT设备

__缺点__

* 每个服务都需要配置不同的端口转发


### 如何禁止端口转发

设置ssh服务配置文件`/etc/ssh/sshd_config`  

	AllowTcpForwarding no


### 参考文献
1. [SSH Tunneling Explained](http://chamibuddhika.wordpress.com/2012/03/21/ssh-tunnelling-explained/)
2. [How to do SSH Tunneling (Port Forwarding) ](http://www.ramkitech.com/2012/04/how-to-do-ssh-tunneling-port-forwarding.html)
3. [SSH端口转发以及应用实例](http://www.liugj.com/2013/04/SSH-port-forwarding/)
